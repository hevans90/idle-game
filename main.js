(()=>{"use strict";var e=[,e=>{e.exports=require("tslib")},e=>{e.exports=require("cors")},e=>{e.exports=require("express")},e=>{e.exports=require("http")},e=>{e.exports=require("@colyseus/monitor")},e=>{e.exports=require("colyseus")},(e,t,o)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.GameRoom=void 0;const s=o(1),i=o(6),n=o(8),r=o(19),a=o(21),l=o(25),d=o(28),c=o(29),p=o(30),y=o(31),u=o(32);class GameRoom extends i.Room{constructor(){super(...arguments),this.gridClients={},this.collisionsUnderResolution={}}onAuth(e,t,o){return s.__awaiter(this,void 0,void 0,(function*(){const{userId:s,displayName:i}=yield(0,a.onAuth)(e,t,o);return{userId:s,displayName:i}}))}onCreate(e){(0,l.onCreate)(e,this)}update(e){(0,p.updateShipPositions)(e,this),(0,u.runCollisionDetection)(this),(0,y.processGravity)(this)}onJoin(e,t){(0,d.onJoin)(e,t,this)}onLeave(e,t){return s.__awaiter(this,void 0,void 0,(function*(){const o=this.state.connectedUsers.find((0,r.findByColyseusClient)({client:e})),s=`${o.displayName} (${e.sessionId})`;try{if(t)throw new Error("consented leave");o.connected=!1,this.broadcast(n.ServerStatusMessage.PlayerDisconnected,`${o.displayName} disconnected`),r.logger.warning(`${s} disconnected... they have 45 seconds to rejoin`),yield this.allowReconnection(e,45),o.connected=!0,this.broadcast(n.ServerStatusMessage.PlayerReconnected,`${o.displayName} reconnected`),r.logger.success(`${s} successfully reconnected!`)}catch(i){"consented leave"!==i.message&&r.logger.warning(`${s} timed out`),(0,c.onLeave)(e,t,this)}}))}onDispose(){r.logger.info(`Room (${this.roomId}) 'disposing...`)}}t.GameRoom=GameRoom},(e,t,o)=>{Object.defineProperty(t,"__esModule",{value:!0});const s=o(1);s.__exportStar(o(9),t),s.__exportStar(o(13),t),s.__exportStar(o(17),t),s.__exportStar(o(18),t)},(e,t,o)=>{Object.defineProperty(t,"__esModule",{value:!0});const s=o(1);s.__exportStar(o(10),t),s.__exportStar(o(12),t),s.__exportStar(o(13),t),s.__exportStar(o(14),t),s.__exportStar(o(15),t),s.__exportStar(o(16),t)},(e,t,o)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.ColyseusCelestial=void 0;const s=o(1),i=o(11);class ColyseusCelestial extends i.Schema{constructor({id:e,name:t,radius:o,positionX:s,positionY:i,mass:n}){super(),this.positionX=s,this.positionY=i,this.id=e,this.name=t,this.radius=o,this.mass=n,this.gravityWellMaxRadius=this.mass*this.mass*10*o}}t.ColyseusCelestial=ColyseusCelestial,s.__decorate([(0,i.type)("string"),s.__metadata("design:type",String)],ColyseusCelestial.prototype,"id",void 0),s.__decorate([(0,i.type)("string"),s.__metadata("design:type",String)],ColyseusCelestial.prototype,"name",void 0),s.__decorate([(0,i.type)("number"),s.__metadata("design:type",Number)],ColyseusCelestial.prototype,"radius",void 0),s.__decorate([(0,i.type)("number"),s.__metadata("design:type",Number)],ColyseusCelestial.prototype,"positionX",void 0),s.__decorate([(0,i.type)("number"),s.__metadata("design:type",Number)],ColyseusCelestial.prototype,"positionY",void 0),s.__decorate([(0,i.type)("number"),s.__metadata("design:type",Number)],ColyseusCelestial.prototype,"mass",void 0),s.__decorate([(0,i.type)("number"),s.__metadata("design:type",Number)],ColyseusCelestial.prototype,"gravityWellMaxRadius",void 0)},e=>{e.exports=require("@colyseus/schema")},(e,t,o)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.ColyseusImpulse=void 0;const s=o(1),i=o(11);class ColyseusImpulse extends i.Schema{}t.ColyseusImpulse=ColyseusImpulse,s.__decorate([(0,i.type)("boolean"),s.__metadata("design:type",Boolean)],ColyseusImpulse.prototype,"up",void 0),s.__decorate([(0,i.type)("boolean"),s.__metadata("design:type",Boolean)],ColyseusImpulse.prototype,"right",void 0),s.__decorate([(0,i.type)("boolean"),s.__metadata("design:type",Boolean)],ColyseusImpulse.prototype,"down",void 0),s.__decorate([(0,i.type)("boolean"),s.__metadata("design:type",Boolean)],ColyseusImpulse.prototype,"left",void 0),s.__decorate([(0,i.type)("string"),s.__metadata("design:type",String)],ColyseusImpulse.prototype,"colyseusUserId",void 0)},(e,t,o)=>{var s;Object.defineProperty(t,"__esModule",{value:!0}),t.RoomState=void 0;const i=o(1),n=o(11),r=o(10),a=o(12),l=o(14),d=o(15),c=o(16);class RoomState extends n.Schema{constructor({height:e,width:t}){super(),this.celestials=new n.ArraySchema,this.connectedUsers=new n.ArraySchema,this.impulses=new n.ArraySchema,this.ships=new n.ArraySchema,this.height=e,this.width=t;const{locations:o,columns:s,rows:i}=(({height:e,width:t})=>{const o=[];for(let s=0;s<4;s++)for(let i=0;i<4;i++){const n=t/4,r=e/4;o.push(new d.ColyseusSpawnLocation({x:n*(s+1)-n/2,y:r*(i+1)-r/2}))}return{locations:o,columns:4,rows:4}})({height:e,width:t});this.celestials=new n.ArraySchema(...[new r.ColyseusCelestial({id:"test",name:"sun",positionX:500,positionY:500,radius:50,mass:1})]),this.spawnLocations=new n.ArraySchema(...o),this.columns=s,this.rows=i}}t.RoomState=RoomState,i.__decorate([(0,n.type)("number"),i.__metadata("design:type",Number)],RoomState.prototype,"height",void 0),i.__decorate([(0,n.type)("number"),i.__metadata("design:type",Number)],RoomState.prototype,"width",void 0),i.__decorate([(0,n.type)([r.ColyseusCelestial]),i.__metadata("design:type",Object)],RoomState.prototype,"celestials",void 0),i.__decorate([(0,n.type)([c.ColyseusUser]),i.__metadata("design:type",Object)],RoomState.prototype,"connectedUsers",void 0),i.__decorate([(0,n.type)([a.ColyseusImpulse]),i.__metadata("design:type",Object)],RoomState.prototype,"impulses",void 0),i.__decorate([(0,n.type)([l.ColyseusShip]),i.__metadata("design:type",Object)],RoomState.prototype,"ships",void 0),i.__decorate([(0,n.type)([d.ColyseusSpawnLocation]),i.__metadata("design:type","function"==typeof(s=void 0!==n.ArraySchema&&n.ArraySchema)?s:Object)],RoomState.prototype,"spawnLocations",void 0),i.__decorate([(0,n.type)("number"),i.__metadata("design:type",Number)],RoomState.prototype,"columns",void 0),i.__decorate([(0,n.type)("number"),i.__metadata("design:type",Number)],RoomState.prototype,"rows",void 0)},(e,t,o)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.ColyseusShip=void 0;const s=o(1),i=o(11);class ColyseusShip extends i.Schema{constructor({maxVelocity:e,acceleration:t,colyseusUserId:o,userId:s,positionX:i,positionY:n,width:r,height:a,name:l}){super(),this.positionX=i,this.positionY=n,this.rotation=0,this.velocityX=0,this.velocityY=0,this.maxVelocity=e,this.acceleration=t,this.colyseusUserId=o,this.userId=s,this.width=r,this.height=a,this.name=l}}t.ColyseusShip=ColyseusShip,s.__decorate([(0,i.type)("number"),s.__metadata("design:type",Number)],ColyseusShip.prototype,"rotation",void 0),s.__decorate([(0,i.type)("number"),s.__metadata("design:type",Number)],ColyseusShip.prototype,"width",void 0),s.__decorate([(0,i.type)("number"),s.__metadata("design:type",Number)],ColyseusShip.prototype,"height",void 0),s.__decorate([(0,i.type)("number"),s.__metadata("design:type",Number)],ColyseusShip.prototype,"positionX",void 0),s.__decorate([(0,i.type)("number"),s.__metadata("design:type",Number)],ColyseusShip.prototype,"positionY",void 0),s.__decorate([(0,i.type)("number"),s.__metadata("design:type",Number)],ColyseusShip.prototype,"velocityX",void 0),s.__decorate([(0,i.type)("number"),s.__metadata("design:type",Number)],ColyseusShip.prototype,"velocityY",void 0),s.__decorate([(0,i.type)("number"),s.__metadata("design:type",Number)],ColyseusShip.prototype,"maxVelocity",void 0),s.__decorate([(0,i.type)("number"),s.__metadata("design:type",Number)],ColyseusShip.prototype,"acceleration",void 0),s.__decorate([(0,i.type)("string"),s.__metadata("design:type",String)],ColyseusShip.prototype,"name",void 0),s.__decorate([(0,i.type)("string"),s.__metadata("design:type",String)],ColyseusShip.prototype,"userId",void 0),s.__decorate([(0,i.type)("string"),s.__metadata("design:type",String)],ColyseusShip.prototype,"colyseusUserId",void 0)},(e,t,o)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.ColyseusSpawnLocation=void 0;const s=o(1),i=o(11);class ColyseusSpawnLocation extends i.Schema{constructor({x:e,y:t}){super(),this.x=e,this.y=t}}t.ColyseusSpawnLocation=ColyseusSpawnLocation,s.__decorate([(0,i.type)("number"),s.__metadata("design:type",Number)],ColyseusSpawnLocation.prototype,"x",void 0),s.__decorate([(0,i.type)("number"),s.__metadata("design:type",Number)],ColyseusSpawnLocation.prototype,"y",void 0),s.__decorate([(0,i.type)("string"),s.__metadata("design:type",String)],ColyseusSpawnLocation.prototype,"userId",void 0),s.__decorate([(0,i.type)("string"),s.__metadata("design:type",String)],ColyseusSpawnLocation.prototype,"colyseusUserId",void 0)},(e,t,o)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.ColyseusUser=void 0;const s=o(1),i=o(11);class ColyseusUser extends i.Schema{}t.ColyseusUser=ColyseusUser,s.__decorate([(0,i.type)("string"),s.__metadata("design:type",String)],ColyseusUser.prototype,"accessToken",void 0),s.__decorate([(0,i.type)("string"),s.__metadata("design:type",String)],ColyseusUser.prototype,"displayName",void 0),s.__decorate([(0,i.type)("string"),s.__metadata("design:type",String)],ColyseusUser.prototype,"avatarUrl",void 0),s.__decorate([(0,i.type)("string"),s.__metadata("design:type",String)],ColyseusUser.prototype,"userId",void 0),s.__decorate([(0,i.type)("boolean"),s.__metadata("design:type",Boolean)],ColyseusUser.prototype,"connected",void 0),s.__decorate([(0,i.type)("string"),s.__metadata("design:type",String)],ColyseusUser.prototype,"colyseusUserId",void 0)},(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.basicShip=void 0,t.basicShip={maxVelocity:10,acceleration:1,hullStrength:100,width:25,height:25}},(e,t)=>{var o,s,i;Object.defineProperty(t,"__esModule",{value:!0}),t.isCircleEntity=t.isRectangleEntity=t.ServerGameMessage=t.ServerStatusMessage=t.PlayerMessage=void 0,function(e){e.Impulse="impulse",e.ImpulseStopped="impulse_stopped"}(o||(t.PlayerMessage=o={})),function(e){e.PlayerJoined="player_joined",e.PlayerLeft="player_left",e.PlayerDisconnected="player_disconnected",e.PlayerReconnected="player_reconnected",e.ClientDisconnected="client_disconnected"}(s||(t.ServerStatusMessage=s={})),function(e){e.Collision="collision"}(i||(t.ServerGameMessage=i={}));t.isRectangleEntity=e=>"rectangle"===e.geometry;t.isCircleEntity=e=>"circle"===e.geometry},(e,t,o)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.logger=t.findByClientId=t.findByColyseusClient=t.round=void 0;const s=o(1).__importDefault(o(20));t.round=(e,t=0)=>{const o=Math.pow(10,t),s=e*o*(1+Number.EPSILON);return Math.round(s)/o};t.findByColyseusClient=({client:e})=>t=>(null==t?void 0:t.colyseusUserId)===e.id;t.findByClientId=e=>t=>(null==t?void 0:t.colyseusUserId)===e,t.logger={info:e=>console.log(e),success:e=>console.log(s.default.green(e)),warning:e=>console.log(s.default.yellow(e)),error:e=>console.log(s.default.red(e))}},e=>{e.exports=require("chalk")},(e,t,o)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.onAuth=void 0;const s=o(1),i=o(6),n=o(22),r=s.__importDefault(o(23)),a=s.__importDefault(o(24)),l=o(19);t.onAuth=(e,t,o)=>s.__awaiter(void 0,[e,t,o],void 0,(function*(e,{accessToken:t,displayName:o},s){const{iss:d,sub:c}=(0,a.default)(t),{kid:p}=(0,a.default)(t,{header:!0}),y=(0,r.default)({cache:!0,rateLimit:!0,jwksRequestsPerMinute:5,jwksUri:`${d}.well-known/jwks.json`});let u;try{u=(yield y.getSigningKey(p)).getPublicKey()}catch(h){throw new i.ServerError(500,h)}try{yield new Promise(((e,o)=>{(0,n.verify)(t,u,((t,s)=>{t?o(t):e(s)}))})),l.logger.info(`User ${o}: ${c} successfully validated.`)}catch(m){throw new i.ServerError(400,"invalid access token")}return{userId:c,displayName:o}}))},e=>{e.exports=require("jsonwebtoken")},e=>{e.exports=require("jwks-rsa")},e=>{e.exports=require("jwt-decode")},(e,t,o)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.onCreate=void 0;const s=o(8),i=o(26),n={height:1e3,width:1e3},r={upper:{x:n.width,y:n.height},lower:{x:-n.width,y:-n.height}};t.onCreate=(e,t)=>{t.setSimulationInterval((e=>t.update(e))),t.setState(new s.RoomState(n)),t.clock.start(),t.onMessage(s.PlayerMessage.Impulse,((e,o)=>{t.state.impulses.find((({colyseusUserId:t})=>t===e.id))[o.direction]=!0})),t.onMessage(s.PlayerMessage.ImpulseStopped,((e,o)=>{t.state.impulses.find((({colyseusUserId:t})=>t===e.id))[o.direction]=!1})),t.grid=new i.SpatialHashGrid(r,{height:n.height,width:n.width})}},(e,t,o)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.funcName=t.SpatialHashGrid=void 0;const s=o(27);t.SpatialHashGrid=class SpatialHashGrid{constructor(e,t){this.newClient=(e,t,o,s,i)=>{const n={id:e,name:t,position:o,geometry:i,dimensions:s,cells:{min:null,max:null,nodes:null},queryId:-1};return this.insert(n),n},this.insert=e=>{const{x:t,y:o}=e.position,{width:s,height:i}=e.dimensions,n=this.getCellIndex({x:t-s/2,y:o-i/2}),r=this.getCellIndex({x:t+s/2,y:o+i/2}),a=[];for(let l=n[0],d=r[0];l<=d;++l){a.push([]);for(let t=n[1],o=r[1];t<=o;++t){const o={next:null,prev:null,client:e};a[l-n[0]].push(o),o.next=this.cells[l][t],this.cells[l][t]&&(this.cells[l][t].prev=o),this.cells[l][t]=o}}e.cells.min=n,e.cells.max=r,e.cells.nodes=a},this.getCellIndex=e=>{const t=s.math.sat((e.x-this.bounds.lower.x)/(this.bounds.upper.x-this.bounds.lower.x)),o=s.math.sat((e.y-this.bounds.lower.y)/(this.bounds.upper.y-this.bounds.lower.y));return[Math.floor(t*(this.dimensions.width-1)),Math.floor(o*(this.dimensions.height-1))]},this.findNearby=(e,t)=>{const{x:o,y:s}=e,{width:i,height:n}=t,r=[],a=this.queryIds++,l=this.getCellIndex({x:o-i/2,y:s-n/2}),d=this.getCellIndex({x:o+i/2,y:s+n/2});for(let c=l[0],p=d[0];c<=p;++c)for(let e=l[1],t=d[1];e<=t;++e){let t=this.cells[c][e];for(;t;){const e=t.client;t=t.next,e.queryId!==a&&(e.queryId=a,r.push(e))}}return r},this.findNearbyCircle=(e,t)=>{const o=o=>{const s=e.x-o.x,i=e.y-o.y;return Math.sqrt(s*s+i*i)<=t},{x:s,y:i}=e,n=[],r=this.queryIds++,a=this.getCellIndex({x:s-t,y:i-t}),l=this.getCellIndex({x:s+t,y:i+t});for(let d=a[0],c=l[0];d<=c;++d)for(let e=a[1],t=l[1];e<=t;++e){let t=this.cells[d][e];for(;t;){const e=t.client;t=t.next,o({x:e.position.x,y:e.position.y})&&e.queryId!==r&&(e.queryId=r,n.push(e))}}return n},this.updateClient=e=>{const{x:t,y:o}=e.position,{width:s,height:i}=e.dimensions,n=this.getCellIndex({x:t-s/2,y:o-i/2}),r=this.getCellIndex({x:t+s/2,y:o+i/2});e.cells.min[0]===n[0]&&e.cells.min[1]===n[1]&&e.cells.max[0]===r[0]&&e.cells.max[1]===r[1]||(this.removeClient(e),this.insert(e))},this.removeClient=e=>{const t=e.cells.min,o=e.cells.max;for(let s=t[0],i=o[0];s<=i;++s)for(let n=t[1],r=o[1];n<=r;++n){const o=s-t[0],i=n-t[1],r=e.cells.nodes[o][i];r.next&&(r.next.prev=r.prev),r.prev&&(r.prev.next=r.next),r.prev||(this.cells[s][n]=r.next)}e.cells.min=null,e.cells.max=null,e.cells.nodes=null},this.bounds=e,this.dimensions=t,this.cells=[...Array(t.width)].map((e=>[...Array(t.height)].map((()=>null)))),this.queryIds=0}};t.funcName=e=>{}},(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.math=void 0,t.math={rand_range:(e,t)=>Math.random()*(t-e)+e,rand_normalish:function(){return(Math.random()+Math.random()+Math.random()+Math.random())/4*2-1},rand_int:function(e,t){return Math.round(Math.random()*(t-e)+e)},lerp:function(e,t,o){return e*(o-t)+t},smoothstep:function(e,t,o){return(e=e*e*(3-2*e))*(o-t)+t},smootherstep:function(e,t,o){return(e=e*e*e*(e*(6*e-15)+10))*(o-t)+t},clamp:function(e,t,o){return Math.min(Math.max(e,t),o)},sat:e=>Math.min(Math.max(e,0),1)}},(e,t,o)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.onJoin=void 0;const s=o(8),i=o(6),n=o(19);t.onJoin=(e,t,o)=>{if(o.state.connectedUsers.find((({userId:e})=>e===t.userId)))throw new i.ServerError(403,"You are already connected on another device/browser tab!");o.broadcast(s.ServerStatusMessage.PlayerJoined,`${t.displayName} joined!`),o.state.connectedUsers.push(new s.ColyseusUser(Object.assign(Object.assign({},t),{colyseusUserId:e.id,connected:!0}))),o.state.impulses.push(new s.ColyseusImpulse({left:!1,up:!1,right:!1,down:!1,colyseusUserId:e.id}));const r=o.state.spawnLocations.filter((e=>!(null==e?void 0:e.colyseusUserId)||void 0===(null==e?void 0:e.colyseusUserId))),a=r[Math.floor(Math.random()*r.length)];a.userId=t.userId,a.colyseusUserId=e.id;const l=`${t.displayName}'s ship`,d=new s.ColyseusShip(Object.assign(Object.assign({},s.basicShip),{name:l,userId:t.userId,colyseusUserId:e.id,positionX:a.x,positionY:a.y}));o.state.ships.push(d);const c=o.grid.newClient(e.id,l,{x:a.x,y:a.y},{width:d.width,height:d.height},"rectangle");o.gridClients[e.id]=c,n.logger.success(`${t.displayName} (${e.sessionId}) joined!`)}},(e,t,o)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.onLeave=void 0;const s=o(8),i=o(6),n=o(19);t.onLeave=(e,t,o)=>{const r=o.state.connectedUsers.find((0,n.findByColyseusClient)({client:e})),a=o.state.impulses.find((0,n.findByColyseusClient)({client:e})),l=o.state.ships.find((0,n.findByColyseusClient)({client:e})),d=o.state.spawnLocations.find((0,n.findByColyseusClient)({client:e}));e.send(s.ServerStatusMessage.ClientDisconnected,"You were disconnected."),o.broadcast(t?s.ServerStatusMessage.PlayerLeft:s.ServerStatusMessage.PlayerDisconnected,`${r.displayName} ${t?"left":"disconnected"}`);const c=o.state.connectedUsers.indexOf(r);o.state.connectedUsers.splice(c,1);const p=o.state.impulses.indexOf(a);o.state.impulses.splice(p,1);const y=o.state.ships.indexOf(l);o.state.ships.splice(y,1);const u=o.state.spawnLocations.indexOf(d);o.state.spawnLocations[u]=new s.ColyseusSpawnLocation({x:d.x,y:d.y}),n.logger.info(`${r.displayName} (${e.sessionId}) ${t?"left voluntarily":"was disconnected"}.`);const h=o.gridClients[r.colyseusUserId];if(!h)throw new i.ServerError(500,`could not find collision client for ${r.colyseusUserId} for removal`);o.grid.removeClient(h),delete o.gridClients[r.colyseusUserId]}},(e,t,o)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.updateShipPositions=void 0;const s=o(6),i=o(19);t.updateShipPositions=(e,t)=>{t.state.connectedUsers.forEach((o=>{const n=t.state.impulses.find((0,i.findByClientId)(o.colyseusUserId)),r=t.state.ships.find((0,i.findByClientId)(o.colyseusUserId)),a=e,l=a/100*r.acceleration,d=a/200,c=Math.sin(r.rotation),p=Math.cos(r.rotation);(null==n?void 0:n.up)&&(r.velocityX=(0,i.round)(r.velocityX+c*l,2),r.velocityY=(0,i.round)(r.velocityY-p*l,2)),(null==n?void 0:n.down)&&(r.velocityX=(0,i.round)(r.velocityX-c*l,2),r.velocityY=(0,i.round)(r.velocityY+p*l,2)),(null==n?void 0:n.left)&&(r.rotation=(0,i.round)(r.rotation-d,2)),(null==n?void 0:n.right)&&(r.rotation=(0,i.round)(r.rotation+d,2));const y=(0,i.round)(r.positionX+r.velocityX,2),u=(0,i.round)(r.positionY+r.velocityY,2);r.positionX=y,r.positionY=u;const h=t.gridClients[o.colyseusUserId];if(!h)throw new s.ServerError(500,`could not find collision client for ${o.colyseusUserId}`);h.position.x=y,h.position.y=u,t.grid.updateClient(h)}))}},(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.processGravity=void 0;t.processGravity=e=>{e.state.celestials.forEach((t=>{const{positionX:o,positionY:s,gravityWellMaxRadius:i}=t,n=e.grid.findNearbyCircle({x:o,y:s},i);n.length&&n.forEach((o=>{const s=e.state.ships.find((({colyseusUserId:e})=>e===o.id));if(s){const{fx:e,fy:o}=((e,t)=>{const o=e.positionX-t.positionX,s=e.positionY-t.positionY,i=((e,t)=>Math.round(100*Math.hypot(e,t))/100)(o,s),n=Math.atan2(s,o),r=100*e.mass*1/Math.pow(i,2);return{fx:r*Math.cos(n),fy:r*Math.sin(n)}})(t,s);s.velocityX+=e,s.velocityY+=o}else console.error("No ship found for colyseus user ID:",o.name)}))}))}},(e,t,o)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.runCollisionDetection=void 0;const s=o(1),i=o(8),n=s.__importDefault(o(33)),r=o(34),a=(0,n.default)(((e,t)=>e.send(i.ServerGameMessage.Collision,t)),2e3),l=({nearbyClients:e,room:t,target:o})=>{e.forEach((e=>{const s=`client-${e.id}__${o.id}`;if(console.log("id",s),console.log("collision between",{client:e.name,target:o.name}),s in t.collisionsUnderResolution)return void console.log("collision already being resolved for these entities",s);let i;"rectangle"===e.geometry?i={id:e.id,position:e.position,geometry:"rectangle",width:e.dimensions.width,height:e.dimensions.height,name:e.name,bounciness:.8}:"circle"===e.geometry&&(i={id:e.id,position:e.position,geometry:"circle",radius:e.dimensions.radius,name:e.name,bounciness:.8});const n={id:s,target:o,client:i};t.collisionsUnderResolution[n.id]=n;const l=t.clients.find((({id:t})=>t===e.id));l&&a(l,n),(0,r.resolveCollision)(n,t)}))};t.runCollisionDetection=e=>{e.state.ships.forEach((t=>{const{positionX:o,positionY:s,width:i,height:n,name:r,colyseusUserId:a}=t,d=e.grid.findNearby({x:o,y:s},{width:i,height:n}).filter((({id:e})=>e!==a));d.length&&l({nearbyClients:d,room:e,target:{id:a,name:r,position:{x:o,y:s},geometry:"rectangle",width:i,height:n,bounciness:.8}})})),e.state.celestials.forEach((t=>{const{positionX:o,positionY:s,radius:i,name:n,id:r}=t,a=e.grid.findNearbyCircle({x:o,y:s},i);a.length&&l({nearbyClients:a,room:e,target:{id:`celestial_${n}-${r}`,name:n,position:{x:o,y:s},geometry:"circle",radius:i,bounciness:.2}})}))}},e=>{e.exports=require("lodash/throttle")},(e,t,o)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.resolveCollision=void 0;const s=o(8),i=o(35),n=4e-4;t.resolveCollision=(e,t)=>{const{client:o,target:r}=e,a=t.state.ships.find((({colyseusUserId:e})=>e===o.id)),l=t.state.ships.find((({colyseusUserId:e})=>e===r.id));if(a||console.error("Collision resolution: No ship found for grid client :",o.id),a&&l)return console.log("ship-ship",o.id,r.id),(0,i.resolveShipToShipCollision)(e,t,a,l);const d=o.position.x,c=o.position.y,p=r.position.x,y=r.position.y;let u,h,m,_;(0,s.isRectangleEntity)(o)&&(m=o.height,_=o.width),(0,s.isCircleEntity)(o)&&(m=o.radius,_=o.radius),(0,s.isRectangleEntity)(r)&&(u=r.height,h=r.width),(0,s.isCircleEntity)(r)&&(u=r.radius,h=r.radius);const v=r.position.x+h/2,g=r.position.y-u/2,f=r.position.x-h/2,C=r.position.y+u/2,S=(p-d)/(h/2),b=(y-c)/(u/2),x=Math.abs(S),w=Math.abs(b);Math.abs(x-w)<.1?(S<0?(a.positionX=v+_,o.position.x=v+_):(a.positionX=f-_,o.position.x=f-_),b<0?(a.positionY=C+m,o.position.y=C+m):(a.positionY=g-m,o.position.y=g-m),Math.random()<.5?(a.velocityX=-a.velocityX*r.bounciness,Math.abs(a.velocityX)<n&&(a.velocityX=0)):(a.velocityY=-a.velocityY*r.bounciness,Math.abs(a.velocityY)<n&&(a.velocityY=0))):x>w?(S<0?(o.position.x=v+_,a.positionX=v+_):(o.position.x=f-_,a.positionX=f-_),a.velocityX=-a.velocityX*r.bounciness,Math.abs(a.velocityX)<n&&(a.velocityX=0)):(b<0?(a.positionY=C+m,o.position.y=C+m):(a.positionY=g-m,o.position.y=g-m),a.velocityY=-a.velocityY*r.bounciness,Math.abs(a.velocityY)<n&&(a.velocityY=0)),delete t.collisionsUnderResolution[e.id]}},(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.resolveShipToShipCollision=void 0;t.resolveShipToShipCollision=(e,t,o,s)=>{const{client:i,target:n}=e,r=((e,t)=>{if(!(e.positionX+e.width<e.positionX||t.positionX+t.width<e.positionX||e.positionY+e.height<t.positionY||t.positionY+t.height<e.positionY)){const o=t.positionX-e.positionX,s=t.positionY-e.positionY;let i=180*Math.atan2(s,o)/Math.PI;return i<0&&(i+=360),i}return null})(o,s);null!==r&&(r>=0&&r<45||r>315&&r<360?(o.velocityX>0&&(o.velocityX=-o.velocityX),s.velocityX<0&&(s.velocityX=-s.velocityX)):r>=45&&r<135?(o.velocityY>0&&(o.velocityY=-o.velocityY),s.velocityY<0&&(s.velocityY=-s.velocityY)):r>=135&&r<225?(o.velocityX<0&&(o.velocityX=-o.velocityX),s.velocityX>0&&(s.velocityX=-s.velocityX)):(o.velocityY<0&&(o.velocityY=-o.velocityY),s.velocityY>0&&(s.velocityY=-s.velocityY))),delete t.collisionsUnderResolution[e.id]}}],t={};function o(s){var i=t[s];if(void 0!==i)return i.exports;var n=t[s]={exports:{}};return e[s](n,n.exports,o),n.exports}var s={};(()=>{var e=s;Object.defineProperty(e,"__esModule",{value:!0});const t=o(1),i=t.__importDefault(o(2)),n=t.__importDefault(o(3)),r=o(4),a=o(5),l=o(6),d=o(7),c=Number(process.env.PORT||1447),p=(0,n.default)();p.use((0,i.default)()),p.use(n.default.json());const y=(0,r.createServer)(p),u=new l.Server({server:y});u.define("my-room",d.GameRoom,{name:"Test",mald:"nice"}),p.use("/colyseus",(0,a.monitor)()),u.listen(c),console.log(`Listening on ws://localhost:${c}`)})();var i=exports;for(var n in s)i[n]=s[n];s.__esModule&&Object.defineProperty(i,"__esModule",{value:!0})})();